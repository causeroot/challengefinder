container_commands:
  01create_post_dir:
    command: "mkdir -p /opt/elasticbeanstalk/hooks/appdeploy/post"
    ignoreErrors: true
  02killjava:
    command: "killall java"
    ignoreErrors: true
  03sudoers:
    command: 'sed ''s/\srequiretty/ \!requiretty/'' /etc/sudoers'
    ignoreErrors: true

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_start_solr.sh":
    mode: "4755"
    owner: "webapp"
    group: "webapp"
    content: |
        #!/bin/bash -l
        cd /var/app/current
        sudo -u webapp bundle install
        sudo -u webapp bundle exec rake assets:precompile
        sudo -u webapp bundle exec rake db:migrate
        sudo -u webapp bundle exec rake sunspot:solr:start || true
        sudo -u webapp bundle exec rake db:seed
